<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Search Vibe | 歌曲資料庫</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;

        // --- 圖示元件 ---
        const UploadIcon = () => (
            <svg className="w-6 h-6 mb-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
        );
        const SearchIcon = () => (
            <svg className="w-5 h-5 text-gray-400 absolute left-4 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        );
        const SpinnerIcon = () => (
            <svg className="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        // --- 骨架屏元件 (Skeleton) ---
        const SkeletonCard = () => (
            <div className="bg-white rounded-xl p-5 shadow-sm border border-slate-100 animate-pulse">
                <div className="flex justify-between items-start mb-2">
                    <div className="h-5 w-12 bg-slate-200 rounded-full"></div>
                    <div className="h-4 w-10 bg-slate-200 rounded"></div>
                </div>
                <div className="h-4 w-24 bg-slate-200 rounded mb-2"></div>
                <div className="h-6 w-3/4 bg-slate-200 rounded mb-4"></div>
                <div className="pt-3 border-t border-slate-50">
                    <div className="h-3 w-20 bg-slate-200 rounded mb-2"></div>
                    <div className="h-4 w-full bg-slate-200 rounded"></div>
                </div>
            </div>
        );

        // --- 主程式 ---
        function App() {
            const [songs, setSongs] = useState([]);
            const [query, setQuery] = useState("");
            const [fileName, setFileName] = useState("");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            // 資料解析與對應核心
            const processData = (data) => {
                 return data.map(row => {
                    const keys = Object.keys(row);
                    const values = Object.values(row);

                    // 輔助查找：標題是否包含關鍵字
                    const findVal = (keywords) => {
                        const foundKey = keys.find(k => keywords.some(keyword => k.toLowerCase().includes(keyword)));
                        return foundKey ? row[foundKey] : null;
                    };

                    // 1. 關鍵字優先匹配
                    let id = findVal(["編號", "id", "no", "code", "序號"]);
                    // 新增：Source 欄位關鍵字
                    let source = findVal(["電影", "劇", "source", "movie", "film", "origin", "出處", "作品"]); 
                    let title = findVal(["歌名", "title", "name", "song", "曲目", "歌曲", "名稱"]);
                    let year = findVal(["年份", "year", "date", "日期", "發行"]);
                    let cast = findVal(["演員", "cast", "配音", "artist", "singer", "演唱", "歌手", "備註"]);

                    // 2. 如果完全抓不到關鍵字，啟用欄位順序備案 (預防全部 undefined)
                    // 假設順序: A=編號, B=電影, C=歌名... (視情況啟用)
                    if (!id && !title && values.length >= 2) {
                        id = values[0];
                        title = values[1];
                    }

                    return {
                        id: id || "N/A",
                        source: source || "-", // 新增
                        title: title || "未命名",
                        year: year || "-",
                        cast: cast || "-"
                    };
                });
            };

            // 範例資料 (包含新欄位)
            const loadDemoData = () => {
                setLoading(true);
                setFileName("Demo_Data.xlsx");
                setTimeout(() => {
                    setSongs([
                        { id: "001", source: "Frozen", title: "Let It Go", year: 2013, cast: "Idina Menzel" },
                        { id: "002", source: "Aladdin", title: "A Whole New World", year: 1992, cast: "Brad Kane" },
                        { id: "003", source: "Coco", title: "Remember Me", year: 2017, cast: "Benjamin Bratt" },
                        { id: "004", source: "The Little Mermaid", title: "Part of Your World", year: 1989, cast: "Jodi Benson" },
                        { id: "005", source: "Lion King", title: "Circle of Life", year: 1994, cast: "Carmen Twillie" },
                    ]);
                    setLoading(false);
                }, 800);
            };

            // 檔案上傳處理
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setLoading(true);
                setFileName(file.name);
                setError(null);
                setSongs([]);

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname]);
                        
                        const normalizedData = processData(data);

                        // 人工延遲 800ms 讓動畫跑完
                        setTimeout(() => {
                            setSongs(normalizedData);
                            setLoading(false);
                        }, 800);

                    } catch (err) {
                        setError("檔案解析失敗，請確認格式。");
                        setLoading(false);
                        console.error(err);
                    }
                };
                reader.readAsBinaryString(file);
            };

            // 搜尋過濾邏輯 (含 Source)
            const filteredSongs = useMemo(() => {
                if (!query) return songs;
                const lowerQ = query.toLowerCase();
                return songs.filter(s => 
                    String(s.title).toLowerCase().includes(lowerQ) || 
                    String(s.id).toLowerCase().includes(lowerQ) ||
                    String(s.source).toLowerCase().includes(lowerQ) // 支援搜電影名
                );
            }, [query, songs]);

            return (
                <div className="min-h-screen pb-10">
                    {/* Header */}
                    <header className="bg-indigo-600 text-white pb-16 pt-10 px-6 shadow-lg">
                        <div className="max-w-4xl mx-auto text-center">
                            <h1 className="text-3xl font-bold tracking-tight mb-2">歌曲資料庫檢索</h1>
                            <p className="text-indigo-100 opacity-80">RWD 極速查詢系統</p>
                        </div>
                    </header>

                    <div className="max-w-4xl mx-auto px-4 -mt-8">
                        {/* 控制面板 */}
                        <div className="glass-panel rounded-2xl shadow-xl p-6 mb-8 relative overflow-hidden">
                            {/* Loading 遮罩 */}
                            {loading && (
                                <div className="absolute inset-0 bg-white/60 z-10 flex items-center justify-center backdrop-blur-sm transition-all">
                                    <div className="flex items-center gap-3 bg-white px-6 py-3 rounded-full shadow-lg border border-indigo-100">
                                        <SpinnerIcon />
                                        <span className="text-indigo-700 font-semibold text-sm">正在解析檔案...</span>
                                    </div>
                                </div>
                            )}

                            {/* 上傳按鈕區 */}
                            <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mb-6">
                                <div className="w-full sm:w-auto flex-1">
                                    <label className={`flex flex-col items-center px-4 py-4 bg-white rounded-xl shadow-sm tracking-wide border border-dashed cursor-pointer transition-all group ${loading ? 'border-gray-200' : 'border-indigo-200 hover:bg-indigo-50 hover:border-indigo-400'}`}>
                                        <div className="flex items-center gap-3">
                                            <UploadIcon />
                                            <span className="text-sm font-semibold text-gray-600 group-hover:text-indigo-600">
                                                {fileName ? `已載入: ${fileName}` : "點擊上傳 Excel 檔案"}
                                            </span>
                                        </div>
                                        <input type='file' className="hidden" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} disabled={loading} />
                                    </label>
                                </div>
                                <button onClick={loadDemoData} disabled={loading} className="text-xs font-medium text-indigo-500 hover:text-indigo-700 underline disabled:opacity-50">
                                    試用範例資料
                                </button>
                            </div>

                            {/* 搜尋框 */}
                            <div className="relative w-full">
                                <SearchIcon />
                                <input 
                                    type="text" 
                                    placeholder="輸入歌名、電影名或編號搜尋..." 
                                    className="w-full pl-11 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all shadow-inner"
                                    value={query}
                                    onChange={(e) => setQuery(e.target.value)}
                                    disabled={loading}
                                />
                            </div>
                            
                            {error && <div className="mt-3 text-red-500 text-sm font-medium text-center">{error}</div>}
                        </div>

                        {/* 結果統計 */}
                        <div className="flex justify-between items-end mb-4 px-2">
                            <h2 className="text-lg font-bold text-slate-700">搜尋結果</h2>
                            <span className="text-sm text-slate-400 bg-slate-100 px-2 py-1 rounded-md">
                                {loading ? "讀取中..." : `共 ${filteredSongs.length} 筆`}
                            </span>
                        </div>

                        {/* 結果列表 (Loading / Empty / List) */}
                        {loading ? (
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                {[...Array(6)].map((_, i) => <SkeletonCard key={i} />)}
                            </div>
                        ) : filteredSongs.length === 0 ? (
                            <div className="text-center py-20 bg-white rounded-2xl border border-dashed border-gray-300">
                                <p className="text-gray-400">
                                    {songs.length === 0 ? "尚未匯入資料" : "找不到符合的歌曲"}
                                </p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                {filteredSongs.map((song, idx) => (
                                    <div key={idx} className="bg-white rounded-xl p-5 shadow-sm border border-slate-100 hover:shadow-md hover:-translate-y-1 transition-all duration-300 group flex flex-col">
                                        
                                        {/* ID & Year */}
                                        <div className="flex justify-between items-start mb-2">
                                            <span className="bg-slate-100 text-slate-500 text-xs font-bold px-2 py-1 rounded-md font-mono">
                                                #{song.id}
                                            </span>
                                            <span className="text-sm text-slate-600 line-clamp-2 leading-relaxed">{song.year}</span>
                                        </div>

                                        {/* Source (電影/劇) */}
                                        <div className="text-sm text-slate-600 line-clamp-2 leading-relaxed">
                                            {song.source}
                                        </div>

                                        {/* Title */}
                                        <h3 className="text-lg font-bold text-slate-800 mb-auto group-hover:text-indigo-600 transition-colors">
                                            {song.title}
                                        </h3>

                                        {/* Cast */}
                                        <div className="mt-4 pt-3 border-t border-slate-50">
                                            <div className="flex items-center gap-2">
                                                <div className="w-1 h-8 bg-indigo-100 rounded-full"></div>
                                                <div>
                                                    <p className="text-[10px] text-slate-400 uppercase tracking-wider">主要演員 / 配音</p>
                                                    <p className="text-sm text-slate-600 line-clamp-2 leading-relaxed">{song.cast}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>